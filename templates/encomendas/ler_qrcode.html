{% extends "base.html" %}

{% block title %}Ler QR Code{% endblock %}

{% block content %}

<h3 class="mb-3"><i class="bi bi-qr-code-scan"></i> Leitor de QR Code</h3>

<a href="{% url 'buscar_encomendas' %}" class="btn btn-outline-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Voltar para busca
</a>

<p class="text-muted text-center">
    Aponte a câmera para o QR Code e alinhe dentro da moldura abaixo.
</p>

<!-- ÁREA DO LEITOR -->
<div style="position: relative; width: 100%; max-width: 400px; margin: 0 auto;">

    <!-- Vídeo -->
    <video id="preview"
           style="width: 100%; border-radius: 12px; background: #000;">
    </video>

    <!-- Overlays -->
    <div class="qr-overlay">
        <div class="qr-frame"></div>
        <div class="qr-line"></div>
    </div>

</div>

<!-- jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<style>
    .qr-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        pointer-events: none;
    }

    /* Moldura quadrada */
    .qr-frame {
        position: absolute;
        top: 50%; left: 50%;
        width: 70%;
        height: 70%;
        transform: translate(-50%, -50%);
        border: 4px solid rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
    }

    /* Linha animada */
    @keyframes scan {
        0% { top: 10%; }
        100% { top: 90%; }
    }

    .qr-line {
        position: absolute;
        left: 15%;
        width: 70%;
        height: 3px;
        background: rgba(0, 255, 0, 0.8);
        border-radius: 3px;
        animation: scan 2s linear infinite alternate;
    }
</style>


<script>
    const video = document.getElementById('preview');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            scanLoop();
        })
        .catch(err => {
            alert("Erro ao acessar a câmera: " + err);
        });

    function scanLoop() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const qr = jsQR(imageData.data, canvas.width, canvas.height);

            if (qr) {
                const codigo = encodeURIComponent(qr.data);
                window.location.href = `/encomendas/scan/processar/?codigo=${codigo}`;
                return;
            }
        }
        requestAnimationFrame(scanLoop);
    }
</script>

{% endblock %}
