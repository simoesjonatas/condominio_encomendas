{% extends "base.html" %}

{% block title %}Ler Código do Pacote{% endblock %}

{% block content %}

<h3 class="mb-3"><i class="bi bi-upc-scan"></i> Ler Identificador do Pacote</h3>

<a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Voltar
</a>

<div style="position:relative; text-align:center;">
    
    <!-- Caixa de foco -->
    <div id="scanner-box" style="
        position:absolute;
        top:50%;
        left:50%;
        width:240px;
        height:240px;
        border:3px solid rgba(255,255,255,0.8);
        border-radius:12px;
        transform:translate(-50%, -50%);
        z-index:10;
        animation:pulse 2s infinite ease-in-out;
        pointer-events:none;
    "></div>

    <!-- Vídeo -->
    <video id="preview"
        style="width:100%; max-width:480px; border-radius:10px; background:#000;">
    </video>

    <!-- Flash -->
    <button id="flash-btn" class="btn btn-dark mt-3" style="display:none;">
        <i class="bi bi-lightning-charge-fill"></i> Flash
    </button>
</div>

<!-- beep -->
<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
@keyframes pulse {
    0% { box-shadow:0 0 0px 0 rgba(255,255,255,0.7); }
    50% { box-shadow:0 0 20px 6px rgba(255,255,255,0.3); }
    100% { box-shadow:0 0 0px 0 rgba(255,255,255,0.7); }
}
</style>

<script>
let video = document.getElementById("preview");
let beep = document.getElementById("beep");
let currentStream = null;
let flashOn = false;

// =========================================================
//  ABRIR CÂMERA NORMAL (PARA QR CODE)
// =========================================================
async function startCamera() {
    const constraints = {
        video: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 },
            advanced: [{ torch: false }]
        }
    };

    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = currentStream;
    video.setAttribute("playsinline", true);
    video.play();

    enableFlashIfSupported();
    scanLoopQR();
    startBarcodeScanner();
}

startCamera();


// =========================================================
//  FLASH
// =========================================================
function enableFlashIfSupported() {
    const track = currentStream.getVideoTracks()[0];
    const capabilities = track.getCapabilities();

    if ("torch" in capabilities) {
        document.getElementById("flash-btn").style.display = "inline-block";
    }
}

document.getElementById("flash-btn").onclick = function () {
    const track = currentStream.getVideoTracks()[0];
    flashOn = !flashOn;

    track.applyConstraints({
        advanced: [{ torch: flashOn }]
    });

    this.innerHTML = flashOn
        ? '<i class="bi bi-lightning-charge"></i> Flash ON'
        : '<i class="bi bi-lightning-charge-fill"></i> Flash';
};


// =========================================================
//  SCAN QR CODE (jsQR)
// =========================================================
function scanLoopQR() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const qr = jsQR(imageData.data, canvas.width, canvas.height);

        if (qr) {
            processCode(qr.data);
            return;
        }
    }

    requestAnimationFrame(scanLoopQR);
}


// =========================================================
//  SCAN BARRAS (QuaggaJS)
// =========================================================
function startBarcodeScanner() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: video,
            constraints: {
                facingMode: "environment"
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "upc_reader",
                "upc_e_reader",
                "codabar_reader",
                "i2of5_reader",
                "code_93_reader"
            ]
        }
    }, function (err) {
        if (err) {
            console.log("Erro Quagga:", err);
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        if (code) {
            processCode(code);
            Quagga.stop();
        }
    });
}


// =========================================================
//  PROCESSAR QUALQUER CÓDIGO LIDO (1D ou QR)
// =========================================================
function processCode(code) {
    let box = document.getElementById("scanner-box");

    // efeito verde
    box.style.border = "3px solid #00ff55";
    box.style.boxShadow = "0 0 20px #00ff55";

    beep.play().catch(() => {});

    setTimeout(() => {
        box.style.border = "3px solid rgba(255,255,255,0.8)";
        box.style.boxShadow = "none";
    }, 400);

    const params = new URLSearchParams(window.location.search);
    params.set("codigo", code);

    window.location.href = "/encomendas/nova/?" + params.toString();
}

</script>

{% endblock %}
