{% extends "base.html" %}

{% block title %}Ler Código do Pacote{% endblock %}

{% block content %}

<h3 class="mb-3"><i class="bi bi-upc-scan"></i> Ler Identificador do Pacote</h3>

<a href="javascript:history.back()" class="btn btn-outline-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Voltar
</a>

<p class="text-muted">
    Aponte a câmera para o QR Code ou código de barras. A leitura é automática.
</p>

<div style="position:relative; text-align:center;">
    
    <!-- Caixa de foco -->
    <div id="scanner-box" style="
        position:absolute;
        top:50%;
        left:50%;
        width:240px;
        height:240px;
        border:3px solid rgba(255,255,255,0.8);
        border-radius:12px;
        transform:translate(-50%, -50%);
        z-index:10;
        pointer-events:none;
        overflow:hidden;
    ">
        <!-- Laser vermelho animado -->
        <div id="laser-line"></div>
    </div>

    <!-- Vídeo -->
    <video id="preview"
        style="width:100%; max-width:480px; border-radius:10px; background:#000;">
    </video>

    <!-- Flash -->
    <button id="flash-btn" class="btn btn-dark mt-3" style="display:none;">
        <i class="bi bi-lightning-charge-fill"></i> Flash
    </button>
</div>

<!-- beep -->
<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<!-- Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
@keyframes pulse {
    0% { box-shadow:0 0 0px 0 rgba(255,255,255,0.7); }
    50% { box-shadow:0 0 20px 6px rgba(255,255,255,0.3); }
    100% { box-shadow:0 0 0px 0 rgba(255,255,255,0.7); }
}

#scanner-box {
    animation: pulse 2s infinite;
}

#laser-line {
    position:absolute;
    left:0;
    right:0;
    height:3px;
    background: linear-gradient(
        to right,
        rgba(255,0,0,0),
        rgba(255,0,0,0.95),
        rgba(255,0,0,0)
    );
    box-shadow:0 0 10px rgba(255,0,0,0.8);
    animation:laser-sweep 2s infinite ease-in-out;
}

@keyframes laser-sweep {
    0% { top:5%; }
    50% { top:90%; }
    100% { top:5%; }
}
</style>

<!-- ================================
      MODAL DE PRÉ-VISUALIZAÇÃO
================================ -->
<div id="preview-modal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

          <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-search"></i> Código detectado</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body text-center">
              <p class="text-muted">Confira o código lido:</p>
              <h3 id="codigo-preview" class="fw-bold"></h3>
          </div>

          <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal" id="cancelar-btn">
                  Cancelar
              </button>

              <button class="btn btn-success" id="confirmar-btn">
                  Confirmar <i class="bi bi-check-lg"></i>
              </button>
          </div>

      </div>
  </div>
</div>

<script>
const redirectUrl = "{% url 'nova_encomenda' %}";

let video = document.getElementById("preview");
let beep = document.getElementById("beep");
let currentStream = null;
let flashOn = false;
let scanning = false;

// Canvas único (performance)
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");


// =============================
// INICIAR CÂMERA
// =============================
async function startCamera() {
    try {
        const constraints = {
            video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 },
                advanced: [{ torch: false }]
            }
        };

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        video.setAttribute("playsinline", true);
        await video.play();

        enableFlashIfSupported();

        scanning = true;
        scanLoopQR();
        startBarcodeScanner();

    } catch (err) {
        console.error("Erro ao iniciar câmera:", err);
        alert("Não foi possível acessar a câmera.");
    }
}
startCamera();


// =============================
// FLASH
// =============================
function enableFlashIfSupported() {
    if (!currentStream) return;
    const track = currentStream.getVideoTracks()[0];
    const capabilities = track.getCapabilities ? track.getCapabilities() : {};
    if ("torch" in capabilities) {
        document.getElementById("flash-btn").style.display = "inline-block";
    }
}

document.getElementById("flash-btn").onclick = function () {
    if (!currentStream) return;
    const track = currentStream.getVideoTracks()[0];

    flashOn = !flashOn;

    track.applyConstraints({
        advanced: [{ torch: flashOn }]
    }).catch(err => console.error("Erro ao ativar flash:", err));

    this.innerHTML = flashOn
        ? '<i class="bi bi-lightning-charge"></i> Flash ON'
        : '<i class="bi bi-lightning-charge-fill"></i> Flash';
};


// =============================
// LEITOR QR (jsQR)
// =============================
function scanLoopQR() {
    if (!scanning) return;

    if (video.readyState === video.HAVE_ENOUGH_DATA) {

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const qr = jsQR(imageData.data, canvas.width, canvas.height);

        if (qr && qr.data) {
            processCode(qr.data);
            return;
        }
    }

    requestAnimationFrame(scanLoopQR);
}


// =============================
// LEITOR DE BARRAS (QuaggaJS)
// =============================
function startBarcodeScanner() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: video,
            constraints: { facingMode: "environment" }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "code_39_reader",
                "upc_reader",
                "upc_e_reader",
                "codabar_reader",
                "i2of5_reader",
                "code_93_reader"
            ]
        }
    }, function(err) {
        if (err) {
            console.error("Erro Quagga:", err);
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        if (!scanning) return;
        const code = result.codeResult && result.codeResult.code;
        if (code) {
            processCode(code);
        }
    });
}


// =============================
// PROCESSAR CÓDIGO LIDO
// =============================
function processCode(code) {
    if (!scanning) return;
    scanning = false;

    try { Quagga.stop(); } catch(e) {}

    // feedback visual
    let box = document.getElementById("scanner-box");
    box.style.border = "3px solid #00ff55";
    box.style.boxShadow = "0 0 20px #00ff55";

    if (navigator.vibrate) navigator.vibrate(80);
    beep.play().catch(() => {});

    // mostra o código no modal
    document.getElementById("codigo-preview").innerText = code;

    const modal = new bootstrap.Modal(document.getElementById("preview-modal"));
    modal.show();

    // cancelar → voltar a escanear
    document.getElementById("cancelar-btn").onclick = () => {
        modal.hide();
        scanning = true;
        box.style.border = "3px solid rgba(255,255,255,0.8)";
        box.style.boxShadow = "none";
        startBarcodeScanner();
        requestAnimationFrame(scanLoopQR);
    };

    // confirmar → redirecionar
    document.getElementById("confirmar-btn").onclick = () => {
        const params = new URLSearchParams(window.location.search);
        params.set("codigo", code);
        window.location.href = redirectUrl + "?" + params.toString();
    };
}


// =============================
// LIMPAR STREAM AO SAIR
// =============================
window.addEventListener("beforeunload", () => {
    try { Quagga.stop(); } catch(e) {}
    if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
    }
});
</script>

{% endblock %}
