{% extends "base.html" %}

{% block title %}Registrar Entrega{% endblock %}

{% block content %}

<div class="card p-4 shadow-sm">

    <h4 class="mb-3">
        <i class="bi bi-box-arrow-down"></i> Registrar Entrega
    </h4>

    <p class="text-muted">
        <strong>Bloco:</strong> {{ e.apartamento.bloco.nome }}<br>
        <strong>Apartamento:</strong> {{ e.apartamento.numero }}<br>
        <strong>Morador:</strong> 
        {% if e.morador %}
            {{ e.morador.nome }}
        {% else %}
            —
        {% endif %}<br>
        <strong>Sequencial:</strong> #{{ e.sequencial_do_dia }}<br>

        {% if e.identificador_pacote %}
            <strong>Identificador do Pacote:</strong>
            <span class="badge bg-primary">{{ e.identificador_pacote }}</span>
        {% endif %}
    </p>

    <form method="post" id="entrega-form">
        {% csrf_token %}

        <input type="hidden" name="assinatura_base64" id="assinatura_base64">

        <div class="mb-3">
            {{ form.retirado_por.label_tag }}
            {{ form.retirado_por }}
        </div>

        <div class="mb-3 text-center">
            <label class="form-label fw-semibold">Assinatura</label>

            <!-- Canvas responsivo -->
            <div style="width: 100%; display:flex; justify-content:center;">
                <canvas id="pad"
                        style="width: 100%; max-width: 600px; height: 260px;
                               border: 1px solid #ccc; border-radius: 6px; background:white;">
                </canvas>
            </div>

            <button type="button" id="limpar"
                    class="btn btn-sm btn-warning mt-2 w-100">
                <i class="bi bi-eraser"></i> Limpar Assinatura
            </button>

            <small class="text-muted d-block mt-2">
                Peça para o morador assinar no quadro acima antes de confirmar a entrega.
            </small>
        </div>

        <button type="submit" class="btn btn-success w-100 mt-3">
            <i class="bi bi-check2-circle"></i> Confirmar Entrega
        </button>
    </form>
</div>

<script>
const canvas = document.getElementById("pad");
const ctx = canvas.getContext("2d");
let desenhando = false;

// Ajusta a resolução real do canvas para evitar assinatura pixelada
function ajustarCanvas() {
    const displayWidth = canvas.clientWidth;
    const displayHeight = canvas.clientHeight;

    canvas.width = displayWidth * 2;   // aumenta resolução
    canvas.height = displayHeight * 2;

    ctx.scale(2, 2);
}

ajustarCanvas();
window.addEventListener("resize", ajustarCanvas);

// Função para bloquear scroll enquanto desenha
function bloquearScroll(e) {
    e.preventDefault();
}

// Posição do mouse/toque relativa ao canvas
function pos(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    return { x, y };
}

// DESKTOP
canvas.addEventListener("mousedown", () => {
    desenhando = true;
    ctx.beginPath();
});
canvas.addEventListener("mouseup", () => desenhando = false);
canvas.addEventListener("mouseleave", () => desenhando = false);
canvas.addEventListener("mousemove", function(e) {
    if (!desenhando) return;
    const p = pos(e);
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
});

// MOBILE
canvas.addEventListener("touchstart", function(e) {
    desenhando = true;
    ctx.beginPath();
    bloquearScroll(e);
}, { passive: false });

canvas.addEventListener("touchend", function(e) {
    desenhando = false;
    bloquearScroll(e);
}, { passive: false });

canvas.addEventListener("touchmove", function(e) {
    if (!desenhando) return;
    const p = pos(e);
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    bloquearScroll(e);
}, { passive: false });

// Verificar se o canvas está vazio
function canvasEstaVazio() {
    const pixelBuffer = new Uint32Array(
        ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
    );
    return !pixelBuffer.some(color => color !== 0);
}

// SALVAR DESENHO NO CAMPO HIDDEN ANTES DE ENVIAR
const form = document.getElementById("entrega-form");

form.addEventListener("submit", function(e) {

    if (canvasEstaVazio()) {
        e.preventDefault();
        alert("Por favor, colete a assinatura antes de confirmar a entrega.");
        return;
    }

    const campo = document.getElementById("assinatura_base64");
    campo.value = canvas.toDataURL("image/png");
});

// LIMPAR CANVAS
document.getElementById("limpar").addEventListener("click", function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
});
</script>

{% endblock %}
