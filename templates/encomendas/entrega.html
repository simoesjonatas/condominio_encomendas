{% extends "base.html" %}

{% block title %}Registrar Entrega{% endblock %}

{% block content %}

<div class="card p-4 shadow-sm">

    <h4 class="mb-3">
        <i class="bi bi-box-arrow-down"></i> Registrar Entrega
    </h4>

    <p class="text-muted">
        <strong>Bloco:</strong> {{ e.apartamento.bloco.nome }}<br>
        <strong>Apartamento:</strong> {{ e.apartamento.numero }}<br>
        <strong>Local armazenado:</strong> {{ e.get_local_armazenado_display }}<br>
        <!-- Descrição -->
        {% if e.descricao %}
                <strong>Descrição:</strong> {{ e.descricao }}<br>
        {% endif %}
        {% comment %} <strong>Morador:</strong> 
        {% if e.morador %}
            {{ e.morador.nome }}
        {% else %}
            —
        {% endif %}<br> {% endcomment %}
        <strong>Sequencial:</strong> #{{ e.sequencial_do_dia }}<br>

        {% if e.identificador_pacote %}
            <strong>Identificador do Pacote:</strong>
            <span class="badge bg-primary">{{ e.identificador_pacote }}</span>
        {% endif %}
    </p>

    <form method="post" id="entrega-form">
        {% csrf_token %}

        <input type="hidden" name="assinatura_base64" id="assinatura_base64">

        <div class="mb-3">
            {{ form.retirado_por.label_tag }}
            {{ form.retirado_por }}
        </div>

        <div class="mb-3 text-center">
            <label class="form-label fw-semibold">Assinatura</label>

            <!-- Canvas responsivo -->
            <div style="width: 100%; display:flex; justify-content:center;">
                <canvas id="pad"
                        style="width: 100%; max-width: 600px; height: 260px;
                               border: 1px solid #ccc; border-radius: 6px; background:white;">
                </canvas>
            </div>

            <small class="text-muted d-block mt-2">
                Peça para o morador assinar no quadro acima antes de confirmar a entrega.
            </small>

            <div class="row g-2 mt-3">
                <div class="col-6">
                    <button type="button" id="limpar" class="btn btn-outline-warning w-100">
                    <i class="bi bi-eraser"></i> Limpar assinatura
                    </button>
                </div>

                <div class="col-6">
                    <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-check2-circle"></i> Confirmar entrega
                    </button>
                </div>
            </div>
            {% comment %} <button type="button" id="limpar"
                    class="btn btn-sm btn-warning mt-2 w-100">
                <i class="bi bi-eraser"></i> Limpar Assinatura
            </button> {% endcomment %}
        </div>
{% comment %} 
        <button type="submit" class="btn btn-success w-100 mt-3">
            <i class="bi bi-check2-circle"></i> Confirmar Entrega
        </button> {% endcomment %}
    </form>
</div>

<!-- Botão flutuante: ir para o final -->
<button type="button" id="btnIrFinal" class="btn btn-primary rounded-circle shadow"
        aria-label="Ir para o final"
        style="
          position: fixed;
          right: 16px;
          bottom: 16px;
          width: 52px;
          height: 52px;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1050;
        ">
  <i class="bi bi-arrow-down"></i>
</button>
<script>
const canvas = document.getElementById("pad");
const ctx = canvas.getContext("2d");
let desenhando = false;

function ajustarCanvas() {
    const displayWidth = canvas.clientWidth;
    const displayHeight = canvas.clientHeight;

    // alta resolução, mas sem scale()
    canvas.width = displayWidth * 2;
    canvas.height = displayHeight * 2;

    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";
}

// Ajusta somente no carregamento
ajustarCanvas();

// posição corrigida considerando o canvas real x canvas visual
function pos(e) {
    const rect = canvas.getBoundingClientRect();

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    const x = (clientX - rect.left) * (canvas.width / rect.width);
    const y = (clientY - rect.top) * (canvas.height / rect.height);

    return { x, y };
}

function bloquearScroll(e) {
    e.preventDefault();
}

// DESKTOP
canvas.addEventListener("mousedown", () => {
    desenhando = true;
    ctx.beginPath();
});
canvas.addEventListener("mouseup", () => desenhando = false);
canvas.addEventListener("mouseleave", () => desenhando = false);

canvas.addEventListener("mousemove", function(e) {
    if (!desenhando) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
});

// MOBILE
canvas.addEventListener("touchstart", function(e) {
    desenhando = true;
    ctx.beginPath();
    bloquearScroll(e);
}, { passive: false });

canvas.addEventListener("touchend", function(e) {
    desenhando = false;
}, { passive: false });

canvas.addEventListener("touchmove", function(e) {
    if (!desenhando) return;
    const p = pos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    bloquearScroll(e);
}, { passive: false });

// Verificar se está vazio
function canvasEstaVazio() {
    const pixels = new Uint32Array(ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer);
    return !pixels.some(color => color !== 0);
}

// processamento no submit
document.getElementById("entrega-form").addEventListener("submit", function(e) {
    if (canvasEstaVazio()) {
        e.preventDefault();
        alert("Por favor, colete a assinatura antes de confirmar a entrega.");
        return;
    }

    document.getElementById("assinatura_base64").value = canvas.toDataURL("image/png");
});

// limpar
document.getElementById("limpar").addEventListener("click", function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
});
</script>


<script>
  // rola até o final (ou até o botão de submit, que é melhor)
  const btnIrFinal = document.getElementById("btnIrFinal");
  const formEntrega = document.getElementById("entrega-form");

  function irParaFinal() {
    // tenta rolar até o botão "Confirmar entrega" primeiro
    const btnSubmit = formEntrega.querySelector('button[type="submit"]');
    if (btnSubmit) {
      btnSubmit.scrollIntoView({ behavior: "smooth", block: "center" });
      return;
    }
    // fallback: final da página
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  btnIrFinal.addEventListener("click", irParaFinal);

  // opcional: esconder o botão quando já estiver bem no final
  function atualizarVisibilidade() {
    const margem = 120; // px
    const chegouNoFinal =
      window.innerHeight + window.scrollY >= document.body.scrollHeight - margem;

    btnIrFinal.style.display = chegouNoFinal ? "none" : "flex";
  }

  window.addEventListener("scroll", atualizarVisibilidade, { passive: true });
  atualizarVisibilidade();
</script>


{% endblock %}
