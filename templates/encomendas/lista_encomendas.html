{% extends "base.html" %}

{% block title %}Encomendas Pendentes{% endblock %}

{% block content %}

<h3 class="mb-3">
    <i class="bi bi-stack"></i> Encomendas Pendentes
</h3>

<div class="d-flex justify-content-end mb-3">
    <a href="{% url 'selecao_impressao' %}" class="btn btn-warning me-2">
        <i class="bi bi-printer-fill"></i> Impressão em Massa
    </a>
    <a href="{% url 'nova_encomenda' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nova Encomenda
    </a>
</div>

<form method="get" class="card p-3 mb-4 shadow-sm">

    <div class="row g-3">

        <!-- FILTRO DE BLOCO -->
        <div class="col-md-3">
            <label class="form-label">Bloco</label>
            <select name="bloco" id="bloco-select" class="form-select">
                <option value="">Todos</option>
                {% for b in blocos %}
                    <option value="{{ b.id }}" {% if f_bloco == b.id|stringformat:'s' %}selected{% endif %}>
                        {{ b.nome }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- FILTRO DE APARTAMENTO (subfiltro do bloco) -->
        <div class="col-md-3">
            <label class="form-label">Apartamento</label>
            <select name="apto" id="apto-select" class="form-select">
                <option value="">Todos</option>

                {# Se não tiver bloco filtrado, mostra todos #}
                {% if not f_bloco %}
                    {% for a in apartamentos %}
                        <option value="{{ a.id }}" {% if f_apto == a.id|stringformat:'s' %}selected{% endif %}>
                            {{ a.bloco.nome }} - {{ a.numero }}
                        </option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>

        <!-- DATA -->
        <div class="col-md-3">
            <label class="form-label">Data de Recebimento</label>
            <input type="date" name="data" class="form-control" value="{{ f_data }}">
        </div>

        <!-- BUSCA -->
        <div class="col-md-3">
            <label class="form-label">Buscar</label>
            <input
                type="text"
                name="busca"
                class="form-control"
                placeholder="Nome do morador ou descrição"
                value="{{ f_busca }}"
            >
        </div>

    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">

    <a href="{% url 'ler_qrcode' %}" class="btn btn-dark">
        <i class="bi bi-qr-code-scan"></i> Ler QR Code
    </a>

    <div class="d-flex gap-2">
        <a href="{% url 'lista_encomendas' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Limpar Filtros
        </a>

        <button class="btn btn-primary">
            <i class="bi bi-search"></i> Filtrar
        </button>
    </div>

</div>


</form>

{% if encomendas %}

    <div class="list-group">

        {% for e in encomendas %}
            <div class="list-group-item list-group-item-action mb-2 shadow-sm rounded">

                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-1 fw-bold">
                        Bloco {{ e.apartamento.bloco.nome }} · Apto {{ e.apartamento.numero }}
                    </h5>

                    <span class="badge bg-primary">
                        #{{ e.sequencial_do_dia }}
                    </span>
                </div>

                <p class="mb-1 text-muted">
                    Identificador pacote: <strong>{{ e.identificador_pacote }}</strong><br>
                    Recebido em: {{ e.data_recebimento }}
                </p>

                {% if e.descricao %}
                    <p class="text-muted small">Pacote: {{ e.descricao }}</p>
                {% endif %}

                <div class="mt-3 d-flex gap-2">
                    <a href="{% url 'entregar_encomenda' e.pk %}" class="btn btn-success w-100">
                        <i class="bi bi-pencil"></i> Registrar Entrega
                    </a>

                    <a href="{% url 'detalhes_encomenda' e.pk %}" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-search"></i> Detalhes
                    </a>
                </div>

            </div>
        {% endfor %}

    </div>

    <!-- PAGINAÇÃO -->
{% if page_obj %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">

        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}
                        &bloco={{ f_bloco|default_if_none:'' }}
                        &apto={{ f_apto|default_if_none:'' }}
                        &data={{ f_data|default_if_none:'' }}
                        &busca={{ f_busca|default_if_none:'' }}">
                    « Anterior
                </a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">« Anterior</span></li>
        {% endif %}

        <li class="page-item disabled">
            <span class="page-link">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>
        </li>

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}
                       &bloco={{ f_bloco|default_if_none:'' }}
                        &apto={{ f_apto|default_if_none:'' }}
                        &data={{ f_data|default_if_none:'' }}
                        &busca={{ f_busca|default_if_none:'' }}">
                    Próxima »
                </a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Próxima »</span></li>
        {% endif %}

    </ul>
</nav>
{% endif %}


{% else %}

    <div class="alert alert-info">
        Nenhuma encomenda pendente no momento.
    </div>

{% endif %}

<!-- JAVASCRIPT DO SUBFILTRO -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const blocoSelect = document.getElementById("bloco-select");
    const aptoSelect  = document.getElementById("apto-select");

    // URL template da sua rota
    const urlTemplate = "{% url 'ajax_apartamentos_bloco' 99999 %}";

    function carregarApartamentos(blocoId, aptoSelecionado = null) {

        aptoSelect.innerHTML = '<option value="">Todos</option>';

        if (!blocoId) return;

        const url = urlTemplate.replace("99999", blocoId);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                data.forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.id;
                    opt.textContent = a.numero;
                    if (aptoSelecionado && aptoSelecionado == a.id) {
                        opt.selected = true;
                    }
                    aptoSelect.appendChild(opt);
                });
            });
    }

    // Atualiza quando o bloco for alterado
    blocoSelect.addEventListener("change", function () {
        carregarApartamentos(this.value);
    });

    // Se a página já veio filtrada, recarrega os apartamentos do bloco selecionado
    {% if f_bloco %}
        carregarApartamentos("{{ f_bloco }}", "{{ f_apto }}");
    {% endif %}
});
</script>

{% endblock %}
